name: Build All Emulators

on:
  schedule:
    - cron: '0 4 * * 0'
  workflow_dispatch:
  workflow_call:
    inputs:
      force:
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

concurrency:
  group: build-emulators
  cancel-in-progress: true

env:
  CACHE_KEY: emu-deps-base-v4
  BUILD_TIMEOUT: 19800  # 5h30 in seconds (leave 30min for cache save)

jobs:
  # ===========================================================================
  # PREPARE: Create and cache base image with all dependencies
  # ===========================================================================
  prepare:
    runs-on: ubuntu-24.04
    outputs:
      devices: ${{ steps.load-devices.outputs.devices }}
      seed_device: ${{ steps.load-devices.outputs.seed_device }}
      devices_rest: ${{ steps.load-devices.outputs.devices_rest }}
      chain_1_ind: ${{ steps.chains.outputs.chain_1_ind }}
      chain_1_dep: ${{ steps.chains.outputs.chain_1_dep }}
      chain_2_ind: ${{ steps.chains.outputs.chain_2_ind }}
      chain_2_dep: ${{ steps.chains.outputs.chain_2_dep }}
      chain_3_ind: ${{ steps.chains.outputs.chain_3_ind }}
      chain_3_dep: ${{ steps.chains.outputs.chain_3_dep }}
      chain_4_ind: ${{ steps.chains.outputs.chain_4_ind }}
      chain_4_dep: ${{ steps.chains.outputs.chain_4_dep }}
      aggregators: ${{ steps.chains.outputs.aggregators }}
      any_build: ${{ steps.chains.outputs.any_build }}
      versions_json: ${{ steps.chains.outputs.versions_json }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Load device matrix
        id: load-devices
        run: |
          DEVICES=$(yq -o=json -I=0 '.devices' devices.yml)
          echo "devices=$DEVICES" >> $GITHUB_OUTPUT
          SEED=$(echo "$DEVICES" | jq -c '.[0]')
          REST=$(echo "$DEVICES" | jq -c 'if length > 1 then .[1:] else [] end')
          echo "seed_device=$SEED" >> $GITHUB_OUTPUT
          echo "devices_rest=$REST" >> $GITHUB_OUTPUT

      - name: Fetch latest versions
        id: versions
        run: |
          EMUS_JSON=$(yq -o=json '.emulators' emulators.yml)
          VERSIONS="{}"

          for i in $(seq 0 $(( $(echo "$EMUS_JSON" | jq 'length') - 1 ))); do
            emu_id=$(echo "$EMUS_JSON" | jq -r ".[$i].id")
            source=$(echo "$EMUS_JSON" | jq -r ".[$i].version_source")
            repo=$(echo "$EMUS_JSON" | jq -r ".[$i].repo // empty")
            host=$(echo "$EMUS_JSON" | jq -r ".[$i].repo_host // empty")
            branch=$(echo "$EMUS_JSON" | jq -r ".[$i].version_branch // empty")

            case "$source" in
              github-release)
                version=$(curl -fsSL "https://api.github.com/repos/$repo/releases/latest" | jq -r '.tag_name // empty')
                if [[ -z "$version" || "$version" == "null" ]]; then
                  echo "ERROR: Failed to fetch $emu_id version"
                  exit 1
                fi
                ;;
              github-commit)
                version=$(curl -fsSL "https://api.github.com/repos/$repo/commits/$branch" | jq -r '.sha // empty')
                if [[ -z "$version" || "$version" == "null" ]]; then
                  echo "ERROR: Failed to fetch $emu_id commit"
                  exit 1
                fi
                ;;
              gitlab-release)
                # URL-encode the repo path for GitLab API
                encoded_repo=$(echo "$repo" | sed 's|/|%2F|g')
                version=$(curl -fsSL "https://gitlab.com/api/v4/projects/$encoded_repo/releases" | jq -r '.[0].tag_name // empty')
                if [[ -z "$version" || "$version" == "null" ]]; then
                  echo "ERROR: Failed to fetch $emu_id version"
                  exit 1
                fi
                ;;
              hash-only)
                version=""
                ;;
            esac

            if [[ -n "$version" ]]; then
              VERSIONS=$(echo "$VERSIONS" | jq --arg id "$emu_id" --arg v "$version" '. + {($id): $v}')
              echo "  $emu_id: $version"
            fi
          done

          echo "versions_json<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Fetch success markers
        id: markers
        run: |
          MARKERS=$(gh api repos/${{ github.repository }}/actions/caches \
            --paginate --jq '.actions_caches[].key' | grep '^success-' || true)
          echo "markers_list<<EOF" >> $GITHUB_OUTPUT
          echo "$MARKERS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Compute build chains
        id: chains
        run: |
          VERSIONS_JSON='${{ steps.versions.outputs.versions_json }}'
          MARKERS_LIST='${{ steps.markers.outputs.markers_list }}'
          FORCE="${{ github.event_name == 'workflow_dispatch' || inputs.force == true }}"
          export VERSIONS_JSON MARKERS_LIST FORCE GITHUB_OUTPUT
          bash scripts/compute-chains.sh

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Restore arm64 cached image
        id: cache-arm64
        uses: actions/cache/restore@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}-arm64

      - name: Create base image if not cached
        if: steps.cache-arm64.outputs.cache-hit != 'true'
        run: |
          docker run --name emu-deps --platform linux/arm64 ubuntu:24.04 bash -c 'echo "base image"'
          docker commit emu-deps emu-deps-image
          docker save emu-deps-image -o /tmp/emu-deps.tar
          docker rm emu-deps

      - name: Load arm64 base image
        run: docker load -i /tmp/emu-deps.tar

      - name: Install dependencies into base image
        if: steps.cache-arm64.outputs.cache-hit != 'true'
        run: |
          docker run --name emu-deps-update --platform linux/arm64 \
            emu-deps-image bash -c '
              set -e
              export DEBIAN_FRONTEND=noninteractive

              apt-get update
              apt-get install -y \
                build-essential cmake ninja-build git pkg-config meson dpkg-dev \
                clang llvm lld libc++-dev libc++abi-dev \
                ccache patchelf \
                python3 python3-pip python3-yaml \
                libjemalloc-dev libwayland-dev \
                qt6-base-dev qt6-base-private-dev qt6-multimedia-dev qt6-tools-dev \
                libqt6opengl6-dev libqt6svg6-dev \
                qtbase5-dev qtbase5-private-dev qtmultimedia5-dev qttools5-dev \
                libsdl2-dev libsdl2-ttf-dev \
                libavcodec-dev libavformat-dev libavutil-dev libswscale-dev libavfilter-dev \
                libssl-dev libcurl4-openssl-dev \
                libfmt-dev libzstd-dev libpng-dev liblz4-dev libbz2-dev \
                libpugixml-dev nlohmann-json3-dev \
                libusb-1.0-0-dev libhidapi-dev libevdev-dev \
                libspeexdsp-dev glslang-tools spirv-tools \
                libboost-serialization-dev libboost-context-dev libcubeb-dev libenet-dev \
                libsfml-dev libminiupnpc-dev libmbedtls-dev \
                libsystemd-dev libbluetooth-dev libasound2-dev libpulse-dev \
                liblzo2-dev libxxhash-dev libspng-dev \
                extra-cmake-modules \
                libslirp-dev libarchive-dev \
                libglew-dev libsnappy-dev libzip-dev \
                libfreeimage-dev libfreetype-dev libvlc-dev libpoppler-cpp-dev \
                libepoxy-dev libpixman-1-dev libgtk-3-dev \
                libsamplerate0-dev libpcap-dev libglib2.0-dev \
                libfaad-dev libwebp-dev libsharpyuv-dev libwebpmux3 libwebpdemux2 \
                libpng-dev libjpeg-dev \
                libgit2-dev libharfbuzz-dev \
                gettext \
                libdbus-1-dev libfontconfig1-dev libudev-dev \
                libxcb1-dev libxcb-composite0-dev libxcb-cursor-dev libxcb-damage0-dev \
                libxcb-glx0-dev libxcb-icccm4-dev libxcb-image0-dev libxcb-keysyms1-dev \
                libxcb-present-dev libxcb-randr0-dev libxcb-render0-dev libxcb-render-util0-dev \
                libxcb-shape0-dev libxcb-shm0-dev libxcb-sync-dev libxcb-xfixes0-dev \
                libxcb-xinerama0-dev libxcb-xinput-dev libxcb-xkb-dev \
                libxcb-util-dev libxcb-util0-dev libxcb-ewmh-dev libxcb-dri2-0-dev libxcb-dri3-dev \
                libxkbcommon-dev libxkbcommon-x11-dev libx11-xcb-dev libx11-dev libxext-dev \
                libxrender-dev libxi-dev libxkbfile-dev libxrandr-dev libxcursor-dev \
                libdecor-0-dev libegl-dev libopengl-dev libdrm-dev \
                libpipewire-0.3-dev libinput-dev libgudev-1.0-dev \
                libva-dev libopus-dev \
                autoconf automake libtool curl wget xz-utils \
                nasm zlib1g-dev

              apt-get clean
              rm -rf /var/lib/apt/lists/*
            '
      - name: Commit and save arm64 base image
        if: steps.cache-arm64.outputs.cache-hit != 'true'
        run: |
          docker commit emu-deps-update emu-deps-image
          docker save emu-deps-image -o /tmp/emu-deps.tar
          docker rm emu-deps-update

      - name: Save arm64 cached image
        if: steps.cache-arm64.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}-arm64

      - name: Restore amd64 cached image
        id: cache-amd64
        uses: actions/cache/restore@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}-amd64

      - name: Build amd64 base image if not cached
        if: steps.cache-amd64.outputs.cache-hit != 'true'
        run: |
          docker run --name emu-deps-amd64 --platform linux/amd64 ubuntu:24.04 bash -c '
            set -e
            export DEBIAN_FRONTEND=noninteractive

            apt-get update
            apt-get install -y \
              build-essential cmake ninja-build git pkg-config meson dpkg-dev \
              clang llvm lld libc++-dev libc++abi-dev \
              ccache patchelf \
              python3 python3-pip python3-yaml \
              libjemalloc-dev libwayland-dev \
              qt6-base-dev qt6-base-private-dev qt6-multimedia-dev qt6-tools-dev \
              libqt6opengl6-dev libqt6svg6-dev \
              qtbase5-dev qtbase5-private-dev qtmultimedia5-dev qttools5-dev \
              libsdl2-dev libsdl2-ttf-dev \
              libavcodec-dev libavformat-dev libavutil-dev libswscale-dev libavfilter-dev \
              libssl-dev libcurl4-openssl-dev \
              libfmt-dev libzstd-dev libpng-dev liblz4-dev libbz2-dev \
              libpugixml-dev nlohmann-json3-dev \
              libusb-1.0-0-dev libhidapi-dev libevdev-dev \
              libspeexdsp-dev glslang-tools spirv-tools \
              libboost-serialization-dev libboost-context-dev libcubeb-dev libenet-dev \
              libsfml-dev libminiupnpc-dev libmbedtls-dev \
              libsystemd-dev libbluetooth-dev libasound2-dev libpulse-dev \
              liblzo2-dev libxxhash-dev libspng-dev \
              extra-cmake-modules \
              libslirp-dev libarchive-dev \
              libglew-dev libsnappy-dev libzip-dev \
              libfreeimage-dev libfreetype-dev libvlc-dev libpoppler-cpp-dev \
              libepoxy-dev libpixman-1-dev libgtk-3-dev \
              libsamplerate0-dev libpcap-dev libglib2.0-dev \
              libfaad-dev libwebp-dev libsharpyuv-dev libwebpmux3 libwebpdemux2 \
              libpng-dev libjpeg-dev \
              libgit2-dev libharfbuzz-dev \
              gettext \
              libdbus-1-dev libfontconfig1-dev libudev-dev \
              libxcb1-dev libxcb-composite0-dev libxcb-cursor-dev libxcb-damage0-dev \
              libxcb-glx0-dev libxcb-icccm4-dev libxcb-image0-dev libxcb-keysyms1-dev \
              libxcb-present-dev libxcb-randr0-dev libxcb-render0-dev libxcb-render-util0-dev \
              libxcb-shape0-dev libxcb-shm0-dev libxcb-sync-dev libxcb-xfixes0-dev \
              libxcb-xinerama0-dev libxcb-xinput-dev libxcb-xkb-dev \
              libxcb-util-dev libxcb-util0-dev libxcb-ewmh-dev libxcb-dri2-0-dev libxcb-dri3-dev \
              libxkbcommon-dev libxkbcommon-x11-dev libx11-xcb-dev libx11-dev libxext-dev \
              libxrender-dev libxi-dev libxkbfile-dev libxrandr-dev libxcursor-dev \
              libdecor-0-dev libegl-dev libopengl-dev libdrm-dev \
              libpipewire-0.3-dev libinput-dev libgudev-1.0-dev \
              libva-dev libopus-dev \
              autoconf automake libtool curl wget xz-utils \
              nasm zlib1g-dev

            apt-get clean
            rm -rf /var/lib/apt/lists/*
          '
          docker commit emu-deps-amd64 emu-deps-image
          docker save emu-deps-image -o /tmp/emu-deps.tar
          docker rm emu-deps-amd64

      - name: Save amd64 cached image
        if: steps.cache-amd64.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}-amd64

  # ===========================================================================
  # BUILD CHAINS: 4 parallel chains × 2 levels (ind/dep) + aggregators
  # Each chain: max-parallel 3 → total 4×3 = 12 concurrent jobs
  # Auto-assigned from emulators.yml via build_time bin-packing
  # ===========================================================================

  chain-1-ind:
    needs: prepare
    if: fromJSON(needs.prepare.outputs.chain_1_ind)[0] != null
    uses: ./.github/workflows/build-chain.yml
    with:
      chain_matrix: ${{ needs.prepare.outputs.chain_1_ind }}

  chain-1-dep:
    needs: [prepare, chain-1-ind]
    if: "!cancelled() && needs.prepare.result == 'success' && fromJSON(needs.prepare.outputs.chain_1_dep)[0] != null"
    uses: ./.github/workflows/build-chain.yml
    with:
      chain_matrix: ${{ needs.prepare.outputs.chain_1_dep }}

  chain-2-ind:
    needs: prepare
    if: fromJSON(needs.prepare.outputs.chain_2_ind)[0] != null
    uses: ./.github/workflows/build-chain.yml
    with:
      chain_matrix: ${{ needs.prepare.outputs.chain_2_ind }}

  chain-2-dep:
    needs: [prepare, chain-2-ind]
    if: "!cancelled() && needs.prepare.result == 'success' && fromJSON(needs.prepare.outputs.chain_2_dep)[0] != null"
    uses: ./.github/workflows/build-chain.yml
    with:
      chain_matrix: ${{ needs.prepare.outputs.chain_2_dep }}

  chain-3-ind:
    needs: prepare
    if: fromJSON(needs.prepare.outputs.chain_3_ind)[0] != null
    uses: ./.github/workflows/build-chain.yml
    with:
      chain_matrix: ${{ needs.prepare.outputs.chain_3_ind }}

  chain-3-dep:
    needs: [prepare, chain-3-ind]
    if: "!cancelled() && needs.prepare.result == 'success' && fromJSON(needs.prepare.outputs.chain_3_dep)[0] != null"
    uses: ./.github/workflows/build-chain.yml
    with:
      chain_matrix: ${{ needs.prepare.outputs.chain_3_dep }}

  chain-4-ind:
    needs: prepare
    if: fromJSON(needs.prepare.outputs.chain_4_ind)[0] != null
    uses: ./.github/workflows/build-chain.yml
    with:
      chain_matrix: ${{ needs.prepare.outputs.chain_4_ind }}

  chain-4-dep:
    needs: [prepare, chain-4-ind]
    if: "!cancelled() && needs.prepare.result == 'success' && fromJSON(needs.prepare.outputs.chain_4_dep)[0] != null"
    uses: ./.github/workflows/build-chain.yml
    with:
      chain_matrix: ${{ needs.prepare.outputs.chain_4_dep }}

  aggregators:
    needs: [prepare, chain-1-ind, chain-1-dep, chain-2-ind, chain-2-dep, chain-3-ind, chain-3-dep, chain-4-ind, chain-4-dep]
    if: "!cancelled() && needs.prepare.result == 'success' && fromJSON(needs.prepare.outputs.aggregators)[0] != null"
    uses: ./.github/workflows/build-chain.yml
    with:
      chain_matrix: ${{ needs.prepare.outputs.aggregators }}

  # ===========================================================================
  # BUILD-SUPPORT: Build setperf + astralemu-deps-repo (short jobs, combined)
  # ===========================================================================
  build-support:
    needs: prepare
    runs-on: ${{ matrix.device.runner }}
    strategy:
      matrix:
        device: ${{ fromJSON(needs.prepare.outputs.devices) }}
      fail-fast: false
      max-parallel: 3
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Check for device-specific setperf
        id: check
        run: |
          if [[ -f "packages/setperf/${{ matrix.device.id }}/setperf" ]]; then
            echo "has_setperf=true" >> $GITHUB_OUTPUT
          else
            echo "has_setperf=false" >> $GITHUB_OUTPUT
            echo "No setperf for ${{ matrix.device.id }}, skipping"
          fi

      - name: Build setperf package
        if: steps.check.outputs.has_setperf == 'true'
        run: |
          cd packages/setperf
          chmod +x build.sh
          ./build.sh "${{ matrix.device.id }}" "${{ matrix.device.arch }}"

      - name: Upload setperf artifact
        if: steps.check.outputs.has_setperf == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pkg-setperf-${{ matrix.device.id }}
          path: "packages/setperf/*.pkg.tar"
          retention-days: 1

      - name: Build astralemu-deps-repo package
        run: |
          cd packages/astralemu-deps-repo
          chmod +x build.sh
          ./build.sh "${{ matrix.device.id }}" "${{ matrix.device.arch }}" "${{ matrix.device.source_distro }}"

      - name: Upload deps-repo artifact
        uses: actions/upload-artifact@v4
        with:
          name: pkg-astralemu-deps-repo-${{ matrix.device.id }}
          path: "packages/astralemu-deps-repo/*.pkg.tar"
          retention-days: 1

  # ===========================================================================
  # UPDATE REPO: Convert and publish to all distro formats (reusable workflow)
  # Seed device first (builds+deploys shared deps), then rest serialized
  # ===========================================================================
  update-repo-seed:
    needs: [prepare, chain-1-ind, chain-1-dep, chain-2-ind, chain-2-dep, chain-3-ind, chain-3-dep, chain-4-ind, chain-4-dep, aggregators, build-support]
    if: >-
      !cancelled() &&
      (needs.chain-1-ind.result == 'success' ||
       needs.chain-2-ind.result == 'success' ||
       needs.chain-3-ind.result == 'success' ||
       needs.chain-4-ind.result == 'success' ||
       needs.aggregators.result == 'success' ||
       needs.build-support.result == 'success')
    uses: ./.github/workflows/update-repos.yml
    with:
      artifact_pattern: 'pkg-*-${{ fromJson(needs.prepare.outputs.seed_device).id }}'
      source_distro: ${{ fromJson(needs.prepare.outputs.seed_device).source_distro }}
      device: ${{ fromJson(needs.prepare.outputs.seed_device).id }}
      force_rebuild: false
    secrets:
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

  update-repo:
    needs: [prepare, update-repo-seed, chain-1-ind, chain-1-dep, chain-2-ind, chain-2-dep, chain-3-ind, chain-3-dep, chain-4-ind, chain-4-dep, aggregators, build-support]
    if: >-
      !cancelled() &&
      fromJson(needs.prepare.outputs.devices_rest)[0] != null &&
      (needs.chain-1-ind.result == 'success' ||
       needs.chain-2-ind.result == 'success' ||
       needs.chain-3-ind.result == 'success' ||
       needs.chain-4-ind.result == 'success' ||
       needs.aggregators.result == 'success' ||
       needs.build-support.result == 'success')
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        device: ${{ fromJson(needs.prepare.outputs.devices_rest) }}
    uses: ./.github/workflows/update-repos.yml
    with:
      artifact_pattern: 'pkg-*-${{ matrix.device.id }}'
      source_distro: ${{ matrix.device.source_distro }}
      device: ${{ matrix.device.id }}
      force_rebuild: false
    secrets:
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

  # ===========================================================================
  # SAVE TRACKERS: Update version trackers on main branch
  # ===========================================================================
  save-trackers:
    needs: [prepare, update-repo-seed, update-repo]
    if: "!cancelled() && (needs.update-repo-seed.result == 'success' || needs.update-repo.result == 'success')"
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Save version trackers
        run: |
          VERSIONS_JSON='${{ needs.prepare.outputs.versions_json }}'
          EMUS_JSON=$(yq -o=json '.emulators' emulators.yml)
          emu_count=$(echo "$EMUS_JSON" | jq 'length')

          for (( i=0; i<emu_count; i++ )); do
            emu_id=$(echo "$EMUS_JSON" | jq -r ".[$i].id")
            tracker_file=$(echo "$EMUS_JSON" | jq -r ".[$i].tracker_file // empty")
            version_source=$(echo "$EMUS_JSON" | jq -r ".[$i].version_source")

            if [[ -z "$tracker_file" ]] || [[ "$version_source" == "hash-only" ]]; then
              continue
            fi

            version=$(echo "$VERSIONS_JSON" | jq -r ".\"$emu_id\" // empty")
            if [[ -n "$version" ]]; then
              echo "$version" > ".trackers/$tracker_file"
              echo "Saved $tracker_file = $version"
            fi
          done

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .trackers/
          git commit -m "Update version trackers" || echo "No changes"
          git push origin main
